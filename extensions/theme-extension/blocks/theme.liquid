<script>
  const waitForStorageDataRAF = (callback, timeout = 1000) => {
    const startTime = performance.now();

    const checkStorage = () => {
      const keyPattern = /^varify-experiment-\d+$/;
      const hasMatchingKey = Object.keys(localStorage).some(key => keyPattern.test(key)) ||
        Object.keys(sessionStorage).some(key => keyPattern.test(key));

      if (hasMatchingKey) {
        callback();
      } else if (performance.now() - startTime < timeout) {
        requestAnimationFrame(() => checkStorage());
      } else {
        console.warn("Timeout reached while waiting for storage keys.");
      }
    };

    requestAnimationFrame(() => checkStorage());
  };

  waitForStorageDataRAF(() => {
    if (typeof window.Shopify?.analytics?.publish === 'function') {
      Shopify.analytics.publish("varifyLocalStorage", { len: localStorage.length, account_id: window.varify.iid });
      Shopify.analytics.publish("varifySessionStorage", { len: sessionStorage.length, account_id: window.varify.iid });
    } else {
      console.warn("Shopify.analytics.publish is not a function.");
    }
  });
</script>

{% schema %}
{
  "name": "Varify-io",
  "target": "body",
  "settings": []
}
{% endschema %}
